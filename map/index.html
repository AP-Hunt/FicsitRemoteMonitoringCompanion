<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

    <style type="text/css">
        * {
            box-sizing: border-box;
        }
        html, body {
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100vw;
            height: 100vh;
            background: black;
        }
    </style>

</head>
<body>
    <div id="map"></div>


    <template id="test-tpl">
        <div>
            <p><slot name="some-text">Default </slot></p>
        </div>
    </template>

    <script type="text/javascript">
        class XPopup extends HTMLElement {
            constructor(slotText) {
                super();
                const template = document
                    .getElementById('test-tpl')
                    .content;

                let textSlot = template.querySelector('slot[name="some-text"]');
                textSlot.innerText = slotText;
                const shadowRoot = 
                    this
                    .attachShadow({mode: 'open'})
                    .appendChild(template.cloneNode(true));
            }

            loadContent(){
                console.log("I'm loading content");
            }
        }

        customElements.define('x-popup', XPopup);
    </script>

    <script lang="javascript" type="text/javascript">
        const bounds = [
			[-375e3, -324698.832031],
			[375e3, 425301.832031],
		];
        const map = L.map("map", {
            crs: L.CRS.Simple,
            zoom: -9,
            maxXoom: -5,
            minZoom: -10,
            fullscreenControl: true,
            maxBounds: bounds
        });

        map.setMinZoom(-10);
        map.setMaxZoom(-5);

        map.fitBounds(bounds);
        map.setView(map.getCenter(), -10);

        function gameToWorldCoords(coords){
            return [-coords[0], coords[1]]
        }

        function randBetween(min, max){
            return Math.random() * (max - min) + min;
        }

        function randomXCoord(bounds){
            return randBetween(
                bounds[0][0],
                bounds[1][0]
            )
        }

        function randomYCoord(bounds){
            return randBetween(
                bounds[0][1],
                bounds[1][1]
            )
        }

        let imgOverlayLayer = L.imageOverlay("map-16k.png", bounds);
        imgOverlayLayer.addTo(map);


        function respondToVisibility(element, callback) {
            var options = {
                root: document.documentElement,
            };

            var observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                callback(entry.intersectionRatio > 0);
                });
            }, options);

            observer.observe(element);
        }


        let popup = new XPopup("I've changed");
        L.marker([-1000, 1000], { "title": "Random"}).bindPopup(popup).on("popupopen", popup.loadContent).addTo(map);
    </script>
</body>
</html>